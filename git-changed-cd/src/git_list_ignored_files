#!/bin/bash
git_list_ignored_files() {
    local target_path="$1"
    local git_root

    if [[ ! -e "$target_path" ]]; then
        echo "Error: '$target_path' does not exist." >&2
        return 1
    fi

    target_path=$(realpath "$target_path" 2>/dev/null \
      || readlink -f "$target_path" 2>/dev/null)
    if [[ -z "$target_path" ]]; then
        echo "Error: Failed to resolve absolute path for '$1'." >&2
        return 1
    fi
    echo "Debug: Resolved target_path=$target_path" >&2

    if [[ -d "$target_path" ]]; then
        git_root=$(git -C "$target_path" rev-parse \
          --show-toplevel 2>/dev/null)
    else
        git_root=$(git -C "$(dirname "$target_path")" rev-parse \
          --show-toplevel 2>/dev/null)
    fi

    if [[ -z "$git_root" ]]; then
        echo "Error: '$target_path' is not part of a Git repository." >&2
        return 1
    fi
    echo "Debug: Git repository root=$git_root" >&2

    local ignored_items
    ignored_items=$(git -C "$git_root" status --porcelain --ignored \
      2>/dev/null | grep '^!!' | cut -c4-)
    if [[ -z "$ignored_items" ]]; then
        echo "Debug: No ignored items found in the repository." >&2
        return 0
    fi
    echo "Debug: Found ignored items: $ignored_items" >&2

    while IFS= read -r item; do
        [[ -z "$item" ]] && continue
        local full_path="$git_root/$item"
        echo "Debug: Processing item=$full_path" >&2

        if [[ -d "$full_path" ]]; then
            find "$full_path" -type f \
              -exec realpath {} \; 2>/dev/null \
              || find "$full_path" -type f \
              -exec readlink -f {} \; 2>/dev/null
        elif [[ -f "$full_path" ]]; then
            realpath "$full_path" 2>/dev/null \
              || readlink -f "$full_path" 2>/dev/null
        fi
    done <<< "$ignored_items"
}

# Run only if not sourced
if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    if [[ -n "$1" ]]; then
        echo "Listing ignored files in Git repository at: $1"
        git_list_ignored_files "$1"
    else
        echo "Error: No path provided. Usage: $0 <path>" >&2
        exit 1
    fi
fi
